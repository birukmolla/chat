<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Chat (Firebase)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .message-bubble-self {
            background-color: #0084ff;
            color: white;
            border-bottom-right-radius: 0;
        }
        .message-bubble-other {
            background-color: #e4e6eb;
            color: #333;
            border-bottom-left-radius: 0;
        }
        /* Custom scrollbar styles */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px; /* Increased max-width for admin modal */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .system-message {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 10px;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            box-sizing: border-box;
            z-index: 10;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="loading-spinner" class="hidden flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mb-4"></div>
        <p class="text-gray-700 text-lg">Loading application...</p>
    </div>

    <!-- Login Form (No signup button here) -->
    <div id="auth-section" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md hidden">
        <h2 id="auth-title" class="text-3xl font-bold text-center mb-6 text-gray-800">Login</h2>
        <p class="text-center text-gray-600 text-sm mb-4">
            New users can only be added by an administrator.
        </p>
        <form id="auth-form">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                <input type="email" id="email" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="your@example.com" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                <input type="password" id="password" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="********" required>
            </div>
            <div id="auth-error-message" class="text-red-600 text-sm mb-4 hidden"></div>
            <button type="submit" id="auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105">Login</button>
        </form>
    </div>

    <!-- Chat Application -->
    <div id="chat-section" class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex overflow-hidden hidden">
        <!-- User List (left pane) -->
        <div class="w-1/4 bg-gray-100 border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-800">Users</h3>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 transition duration-200 ease-in-out">Logout</button>
            </div>
            <div id="user-list" class="flex-grow overflow-y-auto p-3">
                <!-- User items will be dynamically loaded here -->
                <p class="text-gray-500 text-sm text-center mt-4">No other users online yet.</p>
            </div>
            <div class="p-4 border-t border-gray-200 text-center text-gray-600 text-sm flex flex-col items-center">
                <button id="profile-button" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 ease-in-out">Profile</button>
                <button id="admin-panel-button" class="hidden mt-2 bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-lg">Admin Panel</button>
            </div>
        </div>

        <!-- Chat Area (right pane) -->
        <div class="w-3/4 flex flex-col relative">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Public Chat</h3>
                <div class="flex space-x-2">
                    <button id="summarize-chat-button" class="bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 ease-in-out transform hover:scale-105">✨ Summarize Chat</button>
                    <button id="draft-message-button" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 ease-in-out transform hover:scale-105">✨ Draft Message</button>
                </div>
            </div>
            <div id="chat-messages" class="chat-messages flex-grow overflow-y-auto p-4 space-y-4">
                <!-- Messages will be dynamically loaded here -->
            </div>
            <div id="chat-error-notification" class="error-message hidden"></div>
            <div class="p-4 border-t border-gray-200 flex items-center">
                <input type="text" id="message-input" class="flex-grow shadow-sm appearance-none border rounded-lg py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Type your message...">
                <button type="submit" id="send-message-button" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105">Send</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Draft Message Modal -->
    <div id="draft-message-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-draft-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Draft a Message ✨</h3>
            <div class="mb-4">
                <label for="draft-prompt-input" class="block text-gray-700 text-sm font-medium mb-2">What topic should the message be about?</label>
                <input type="text" id="draft-prompt-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="e.g., 'weekend plans', 'team update'">
            </div>
            <button id="generate-draft-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105">Generate Draft</button>
            <div id="draft-loading-spinner" class="hidden flex justify-center mt-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            </div>
            <div id="generated-draft-output" class="bg-gray-100 p-3 rounded-lg mt-4 max-h-48 overflow-y-auto text-gray-800 text-sm border border-gray-200 hidden">
                <!-- Generated draft will appear here -->
            </div>
            <div id="draft-error-message" class="text-red-600 text-sm mt-2 hidden"></div>
            <button id="send-generated-draft-button" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105 hidden">Send Draft to Chat</button>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="edit-message-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-edit-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Edit Message</h3>
            <div class="mb-4">
                <label for="edit-message-input" class="block text-gray-700 text-sm font-medium mb-2">Message Text</label>
                <textarea id="edit-message-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" rows="4"></textarea>
            </div>
            <div id="edit-error-message" class="text-red-600 text-sm mt-2 hidden"></div>
            <button id="save-edited-message-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105">Save Changes</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="confirmation-message">Are you sure?</h3>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Yes</button>
                <button id="confirm-no-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">No</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-admin-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Admin Panel</h3>

            <!-- Add New User Section -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-xl font-semibold mb-3 text-gray-700">Add New User (Email/Password)</h4>
                <div class="mb-3">
                    <label for="admin-add-name" class="block text-gray-700 text-sm font-medium mb-2">New User Name</label>
                    <input type="text" id="admin-add-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., John Smith">
                </div>
                <div class="mb-3">
                    <label for="admin-add-email" class="block text-gray-700 text-sm font-medium mb-2">New User Email</label>
                    <input type="email" id="admin-add-email" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="New user email" required>
                </div>
                <div class="mb-3">
                    <label for="admin-add-password" class="block text-gray-700 text-sm font-medium mb-2">New User Password</label>
                    <input type="password" id="admin-add-password" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="New user password (min 6 chars)" required>
                </div>
                <div id="admin-add-error-message" class="text-red-600 text-sm mb-3 hidden"></div>
                <button id="admin-add-user-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Add User</button>
            </div>

            <!-- Manage Existing Users Section -->
            <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-xl font-semibold mb-3 text-gray-700">Manage Users</h4>
                <div id="admin-user-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-sm text-center">Loading users...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-profile-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">User Profile</h3>

            <div class="mb-4">
                <label for="profile-name-input" class="block text-gray-700 text-sm font-medium mb-2">Name:</label>
                <input type="text" id="profile-name-input" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <div id="profile-name-message" class="text-sm mt-2 hidden"></div>
                <button id="save-profile-name-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full mt-3">Save Name</button>
            </div>
            <div class="mb-4">
                <p class="text-gray-700 text-sm font-medium mb-2">Email:</p>
                <p id="profile-email" class="bg-gray-100 p-2 rounded-lg text-gray-800"></p>
            </div>
            <div class="mb-4">
                <p class="text-gray-700 text-sm font-medium mb-2">User ID:</p>
                <p id="profile-uid" class="bg-gray-100 p-2 rounded-lg text-gray-800 text-xs break-all"></p>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 text-sm font-medium mb-2">Role:</p>
                <p id="profile-role" class="bg-gray-100 p-2 rounded-lg text-gray-800"></p>
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-xl font-semibold mb-3 text-gray-700">Change Password</h4>
                <div class="mb-3">
                    <label for="current-password" class="block text-gray-700 text-sm font-medium mb-2">Current Password</label>
                    <input type="password" id="current-password" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter current password" required>
                </div>
                <div class="mb-3">
                    <label for="new-password" class="block text-gray-700 text-sm font-medium mb-2">New Password</label>
                    <input type="password" id="new-password" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter new password (min 6 characters)" required>
                </div>
                <div id="password-change-error-message" class="text-red-600 text-sm mb-3 hidden"></div>
                <div id="password-change-success-message" class="text-green-600 text-sm mb-3 hidden"></div>
                <button id="change-password-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Change Password</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase imports from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Manually provided Firebase configuration (fallback for local development outside Canvas)
        const defaultFirebaseConfig = {
            apiKey: "YOUR_FALLBACK_API_KEY", // Replace with your actual Firebase API Key for local testing outside Canvas
            authDomain: "chat-app-c7d23.firebaseapp.com",
            projectId: "chat-app-c7d23",
            storageBucket: "chat-app-c7d23.firebasestorage.app",
            messagingSenderId: "391224761393",
            appId: "1:391224761393:web:79b3de2d90813030164910",
            measurementId: "G-XQKWP4BBKQ"
        };

        // Use Canvas's provided Firebase config if available, otherwise use default
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : defaultFirebaseConfig;

        // Global Firebase variables (initialized later)
        let app, db, auth;
        let userId = null;
        let currentUserEmail = null;
        let currentUserName = null; // New: Store current user's name
        let currentUserRole = 'user'; // Default role
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;
        let recentChatMessages = [];

        // UI Elements
        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const authErrorMessage = document.getElementById('auth-error-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logoutButton = document.getElementById('logout-button');
        const adminPanelButton = document.getElementById('admin-panel-button');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const chatMessages = document.getElementById('chat-messages');
        const userList = document.getElementById('user-list');
        const chatErrorNotification = document.getElementById('chat-error-notification');

        // Gemini API related elements
        const summarizeChatButton = document.getElementById('summarize-chat-button');
        const draftMessageButton = document.getElementById('draft-message-button');
        const draftMessageModal = document.getElementById('draft-message-modal');
        const closeDraftModalButton = document.getElementById('close-draft-modal');
        const draftPromptInput = document.getElementById('draft-prompt-input');
        const generateDraftButton = document.getElementById('generate-draft-button');
        const draftLoadingSpinner = document.getElementById('draft-loading-spinner');
        const generatedDraftOutput = document.getElementById('generated-draft-output');
        const draftErrorMessage = document.getElementById('draft-error-message');
        const sendGeneratedDraftButton = document.getElementById('send-generated-draft-button');

        // New Modals for Editing/Confirmation/Admin
        const editMessageModal = document.getElementById('edit-message-modal');
        const closeEditModalButton = document.getElementById('close-edit-modal');
        const editMessageInput = document.getElementById('edit-message-input');
        const saveEditedMessageButton = document.getElementById('save-edited-message-button');
        const editErrorMessage = document.getElementById('edit-error-message');
        let currentEditingMessageId = null;

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');
        let confirmationCallback = null;

        const adminPanelModal = document.getElementById('admin-panel-modal');
        const closeAdminModalButton = document = document.getElementById('close-admin-modal');
        const adminAddNameInput = document.getElementById('admin-add-name'); // New: Admin Add Name Input
        const adminAddEmailInput = document.getElementById('admin-add-email');
        const adminAddPasswordInput = document.getElementById('admin-add-password');
        const adminAddErrorMessage = document.getElementById('admin-add-error-message');
        const adminAddUserButton = document.getElementById('admin-add-user-button');
        const adminUserList = document.getElementById('admin-user-list');

        // Profile Modal Elements
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalButton = document.getElementById('close-profile-modal');
        const profileNameInput = document.getElementById('profile-name-input'); // Changed to input
        const profileNameMessage = document.getElementById('profile-name-message'); // For name change feedback
        const saveProfileNameButton = document.getElementById('save-profile-name-button'); // Save name button
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileRole = document.getElementById('profile-role');
        const currentPasswordInput = document.getElementById('current-password');
        const newPasswordInput = document.getElementById('new-password');
        const passwordChangeErrorMessage = document.getElementById('password-change-error-message');
        const passwordChangeSuccessMessage = document.getElementById('password-change-success-message');
        const changePasswordButton = document.getElementById('change-password-button');


        // Helper function to display temporary messages
        function showTempNotification(message, isError = false) {
            chatErrorNotification.textContent = message;
            chatErrorNotification.classList.remove('hidden');
            if (isError) {
                chatErrorNotification.classList.remove('system-message');
                chatErrorNotification.classList.add('error-message');
            } else {
                chatErrorNotification.classList.remove('error-message');
                chatErrorNotification.classList.add('system-message');
            }
            if (chatErrorNotification.timeoutId) {
                clearTimeout(chatErrorNotification.timeoutId);
            }
            chatErrorNotification.timeoutId = setTimeout(() => {
                chatErrorNotification.classList.add('hidden');
                chatErrorNotification.timeoutId = null;
            }, 5000);
        }

        // Initialize Firebase
        function initializeFirebase() {
            console.log("Initializing Firebase...");
            try {
                app = initializeApp(firebaseConfig);
                getAnalytics(app);

                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized with provided config.");

                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed. Current user:", user ? user.uid : "None");
                    loadingSpinner.classList.add('hidden');
                    if (user && user.email) {
                        userId = user.uid;
                        currentUserEmail = user.email;

                        // Fetch user's role and name from Firestore
                        const dynamicAppId = firebaseConfig.projectId;
                        const userRef = doc(db, `artifacts/${dynamicAppId}/public/data/users`, userId);
                        try {
                            const userSnap = await getDoc(userRef);
                            if (userSnap.exists()) {
                                const userData = userSnap.data();
                                currentUserRole = userData.role || 'user';
                                currentUserName = userData.name || currentUserEmail.split('@')[0]; // Use name or email prefix
                                console.log(`User ${userId} (${currentUserEmail}) logged in. Role: ${currentUserRole}, Name: ${currentUserName}`);

                                // Update profile modal fields
                                profileEmail.textContent = currentUserEmail;
                                profileUid.textContent = userId;
                                profileRole.textContent = currentUserRole.toUpperCase();
                                profileNameInput.value = currentUserName; // Set name input value

                                // If user doesn't have a role or name in Firestore, set default
                                if (!userData.role || !userData.name) {
                                    const updateData = {};
                                    if (!userData.role) updateData.role = 'user';
                                    if (!userData.name) updateData.name = currentUserEmail.split('@')[0];
                                    await setDoc(userRef, updateData, { merge: true });
                                    console.log(`User ${userId} profile updated with default role/name.`);
                                }

                                if (currentUserRole === 'admin') {
                                    adminPanelButton.classList.remove('hidden');
                                } else {
                                    adminPanelButton.classList.add('hidden');
                                }

                                showChatSection();
                                setupChatListeners(dynamicAppId);
                                setupUserListListener(dynamicAppId);
                            } else {
                                console.log(`User ${userId} not in Firestore, creating profile with 'user' role and default name...`);
                                currentUserRole = 'user';
                                currentUserName = currentUserEmail.split('@')[0]; // Default name from email
                                profileEmail.textContent = currentUserEmail;
                                profileUid.textContent = userId;
                                profileRole.textContent = currentUserRole.toUpperCase();
                                profileNameInput.value = currentUserName; // Set name input value

                                await setDoc(userRef, {
                                    email: currentUserEmail,
                                    uid: userId,
                                    role: 'user',
                                    name: currentUserName, // Set default name here
                                    createdAt: serverTimestamp()
                                });
                                console.log(`User ${userId} profile created with 'user' role and default name.`);
                                adminPanelButton.classList.add('hidden');
                                showChatSection();
                                setupChatListeners(dynamicAppId);
                                setupUserListListener(dynamicAppId);
                            }
                        } catch (firestoreError) {
                            console.error("Error fetching/setting user role/name in Firestore:", firestoreError);
                            showTempNotification(`Failed to get/set user profile: ${firestoreError.message}. Check Firestore rules.`, true);
                            showChatSection();
                            setupChatListeners(dynamicAppId);
                            setupUserListListener(dynamicAppId);
                        }

                    } else {
                        console.log("No authenticated email user. Showing auth section.");
                        userId = null;
                        currentUserEmail = null;
                        currentUserName = null;
                        currentUserRole = 'user';

                        if (unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages = null; }
                        if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
                        recentChatMessages = [];
                        adminPanelButton.classList.add('hidden');
                        showAuthSection();
                    }
                });

                if (!auth.currentUser) {
                    console.log("No current user, ensuring auth section is shown.");
                    showAuthSection();
                }

            } catch (e) {
                console.error("Critical error initializing Firebase:", e);
                authSection.classList.remove('hidden');
                authErrorMessage.textContent = 'Failed to initialize application. Please try again later.';
                authErrorMessage.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- UI State Management ---
        function showLoadingSpinner() {
            loadingSpinner.classList.remove('hidden');
            authSection.classList.add('hidden');
            chatSection.classList.add('hidden');
        }

        function showAuthSection() {
            authSection.classList.remove('hidden');
            chatSection.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            authErrorMessage.classList.add('hidden');
            emailInput.value = '';
            passwordInput.value = '';
        }

        function showChatSection() {
            authSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }

        // --- Authentication Handlers ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            authErrorMessage.classList.add('hidden');
            authButton.disabled = true;
            const originalAuthButtonText = authButton.textContent;
            authButton.textContent = 'Logging in...';

            console.log(`Login attempt for Email: ${email}`);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("signInWithEmailAndPassword successful (awaiting onAuthStateChanged).");
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No user found with this email. Please ask an admin to add you.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many login attempts. Please try again later.";
                }
                authErrorMessage.textContent = errorMessage;
            } finally {
                authButton.disabled = false;
                authButton.textContent = originalAuthButtonText;
            }
        });

        logoutButton.addEventListener('click', async () => {
            console.log("Logout button clicked.");
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Logout error:", error);
                showTempNotification(`Logout failed: ${error.message}`, true);
            }
        });

        // --- Chat Functionality ---
        sendMessageButton.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            console.log(`Send message button clicked. Message: "${messageText}", UserID: ${userId}, Email: ${currentUserEmail}, Name: ${currentUserName}`);

            if (!messageText) {
                showTempNotification("Message cannot be empty.", false);
                return;
            }
            if (!userId || !currentUserEmail) {
                showTempNotification("Please log in to send messages.", true);
                return;
            }

            sendMessageButton.disabled = true;
            const originalSendButtonText = sendMessageButton.textContent;
            sendMessageButton.textContent = 'Sending...';

            const dynamicAppId = firebaseConfig.projectId;
            try {
                const collectionPath = `artifacts/${dynamicAppId}/public/data/messages`;
                console.log(`Firestore path for messages: ${collectionPath}`);

                console.log("Attempting to add message to Firestore...");
                await addDoc(collection(db, collectionPath), {
                    senderId: userId,
                    senderEmail: currentUserEmail,
                    senderName: currentUserName, // New: Include sender's name
                    text: messageText,
                    timestamp: serverTimestamp()
                });
                messageInput.value = '';
                console.log("Message sent successfully!");
                showTempNotification("Message sent!", false);
            } catch (error) {
                console.error("Error sending message to Firestore:", error);
                let displayError = "Failed to send message. Please check your internet connection.";
                if (error.code === 'permission-denied') {
                    displayError = "Failed to send message: Permission denied. Check Firebase Security Rules for 'messages' collection.";
                } else if (error.code === 'unavailable' || error.code === 'internal') {
                    displayError = "Network issue or Firestore service unavailable. Please check your internet connection.";
                }
                showTempNotification(displayError, true);
            } finally {
                sendMessageButton.disabled = false;
                sendMessageButton.textContent = originalSendButtonText;
            }
        });

        // Allow sending message with Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessageButton.click();
            }
        });

        function displayMessage(message, append = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-2');
            messageDiv.dataset.messageId = message.id; // Store message ID on the element

            const isSelf = message.senderId === userId;
            const isGemini = message.senderId === 'gemini-summary';

            if (isSelf) {
                messageDiv.classList.add('justify-end');
            } else {
                messageDiv.classList.add('justify-start');
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add(
                'rounded-xl', 'py-2', 'px-4', 'max-w-[70%]', 'break-words', 'shadow-sm',
                isSelf ? 'message-bubble-self' : (isGemini ? 'bg-indigo-100 text-indigo-800' : 'message-bubble-other')
            );
            bubbleDiv.style.position = 'relative'; // For positioning action buttons

            // Sender name (show name, fall back to email prefix)
            const senderSpan = document.createElement('span');
            senderSpan.classList.add('block', 'text-xs', 'font-semibold', 'opacity-80', 'mb-1',
                isSelf ? 'text-right' : 'text-left');
            senderSpan.textContent = isSelf ? 'You' : (message.senderName || (message.senderEmail ? message.senderEmail.split('@')[0] : 'Unknown'));

            // Message text
            const textP = document.createElement('p');
            textP.classList.add('text-sm');
            textP.textContent = message.text;

            // Timestamp
            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('block', 'text-[0.6rem]', 'opacity-60', 'mt-1',
                isSelf ? 'text-right' : 'text-left');
            if (message.timestamp && message.timestamp.toDate) {
                timestampSpan.textContent = message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (message.timestamp && message.timestamp.seconds) {
                const date = new Date(message.timestamp.seconds * 1000 + message.timestamp.nanoseconds / 1000000);
                timestampSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                timestampSpan.textContent = 'Sending...';
            }

            bubbleDiv.appendChild(senderSpan);
            bubbleDiv.appendChild(textP);
            bubbleDiv.appendChild(timestampSpan);
            messageDiv.appendChild(bubbleDiv);

            // Add Edit/Delete buttons if applicable and not a Gemini message
            if (!isGemini) {
                const actionButtonsDiv = document.createElement('div');
                actionButtonsDiv.classList.add('absolute', 'top-0', 'flex', 'space-x-1', 'p-1', 'rounded-lg');
                actionButtonsDiv.style.backgroundColor = 'rgba(255,255,255,0.7)'; // Semi-transparent background

                if (isSelf) {
                    // Current user's message: allow edit and delete
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('text-xs', 'text-blue-600', 'hover:text-blue-800', 'font-semibold', 'px-1');
                    editButton.onclick = () => openEditMessageModal(message.id, message.text);
                    actionButtonsDiv.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('text-xs', 'text-red-600', 'hover:text-red-800', 'font-semibold', 'px-1');
                    deleteButton.onclick = () => confirmAction('Are you sure you want to delete this message?', () => deleteMessage(message.id));
                    actionButtonsDiv.appendChild(deleteButton);

                } else if (currentUserRole === 'admin') {
                    // Admin can delete any message
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('text-xs', 'text-red-600', 'hover:text-red-800', 'font-semibold', 'px-1');
                    deleteButton.onclick = () => confirmAction('Are you sure you want to delete this message as admin?', () => deleteMessage(message.id));
                    actionButtonsDiv.appendChild(deleteButton);
                }

                if (actionButtonsDiv.children.length > 0) {
                     // Adjust position based on self/other
                    if (isSelf) {
                        actionButtonsDiv.style.left = '-60px'; // Adjust as needed
                        actionButtonsDiv.style.top = '0';
                    } else {
                        actionButtonsDiv.style.right = '-60px'; // Adjust as needed
                        actionButtonsDiv.style.top = '0';
                    }
                    bubbleDiv.appendChild(actionButtonsDiv);
                }
            }


            if (append) {
                chatMessages.appendChild(messageDiv);
            } else {
                chatMessages.prepend(messageDiv);
            }
        }

        // Function to open edit message modal
        function openEditMessageModal(messageId, currentText) {
            currentEditingMessageId = messageId;
            editMessageInput.value = currentText;
            editErrorMessage.classList.add('hidden');
            editMessageModal.classList.remove('hidden');
        }

        // Save edited message
        saveEditedMessageButton.addEventListener('click', async () => {
            const newText = editMessageInput.value.trim();
            if (!newText) {
                editErrorMessage.textContent = "Message cannot be empty.";
                editErrorMessage.classList.remove('hidden');
                return;
            }

            if (!currentEditingMessageId) {
                editErrorMessage.textContent = "No message selected for editing.";
                editErrorMessage.classList.remove('hidden');
                return;
            }

            saveEditedMessageButton.disabled = true;
            const originalButtonText = saveEditedMessageButton.textContent;
            saveEditedMessageButton.textContent = 'Saving...';

            const dynamicAppId = firebaseConfig.projectId;
            const messageRef = doc(db, `artifacts/${dynamicAppId}/public/data/messages`, currentEditingMessageId);

            try {
                await updateDoc(messageRef, {
                    text: newText,
                    editedAt: serverTimestamp() // Add an edited timestamp
                });
                console.log(`Message ${currentEditingMessageId} updated successfully.`);
                editMessageModal.classList.add('hidden');
                showTempNotification("Message updated!", false);
            } catch (error) {
                console.error("Error updating message:", error);
                let errorMessage = `Failed to update message: ${error.message}`;
                if (error.code === 'permission-denied') {
                    errorMessage = "Failed to update message: Permission denied. Check Firebase Security Rules for editing your own messages.";
                }
                editErrorMessage.textContent = errorMessage;
                editErrorMessage.classList.remove('hidden');
            } finally {
                saveEditedMessageButton.disabled = false;
                saveEditedMessageButton.textContent = originalButtonText;
            }
        });

        // Close edit message modal
        closeEditModalButton.addEventListener('click', () => {
            editMessageModal.classList.add('hidden');
            currentEditingMessageId = null;
        });

        // Function to delete message
        async function deleteMessage(messageId) {
            const dynamicAppId = firebaseConfig.projectId;
            const messageRef = doc(db, `artifacts/${dynamicAppId}/public/data/messages`, messageId);
            try {
                await deleteDoc(messageRef);
                console.log(`Message ${messageId} deleted successfully.`);
                showTempNotification("Message deleted!", false);
                // The onSnapshot listener will automatically remove it from the UI
            } catch (error) {
                console.error("Error deleting message:", error);
                let errorMessage = `Failed to delete message: ${error.message}`;
                if (error.code === 'permission-denied') {
                    errorMessage = "Failed to delete message: Permission denied. Check Firebase Security Rules.";
                }
                showTempNotification(errorMessage, true);
            }
        }

        // Confirmation Modal Logic
        function confirmAction(message, callback) {
            confirmationMessage.textContent = message;
            confirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        confirmYesButton.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
            }
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        confirmNoButton.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });


        function setupChatListeners(dynamicAppId) {
            console.log("Setting up chat listeners...");
            if (unsubscribeMessages) {
                unsubscribeMessages();
                console.log("Unsubscribed from previous message listener.");
            }

            const messagesCollectionRef = collection(db, `artifacts/${dynamicAppId}/public/data/messages`);
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'), limit(50));

            chatMessages.innerHTML = '';
            recentChatMessages = [];

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const messageData = { id: change.doc.id, ...change.doc.data() }; // Capture document ID
                    if (change.type === "added") {
                        displayMessage(messageData);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        recentChatMessages.push(messageData);
                        if (recentChatMessages.length > 50) {
                            recentChatMessages.shift();
                        }
                    } else if (change.type === "modified") {
                        // Find the existing message element and update its content
                        const existingMessageElement = chatMessages.querySelector(`[data-message-id="${messageData.id}"] p`);
                        if (existingMessageElement) {
                            existingMessageElement.textContent = messageData.text;
                            // Optionally update timestamp if editedAt is visible
                        }
                        // Update in recentChatMessages array for summarization
                        const index = recentChatMessages.findIndex(msg => msg.id === messageData.id);
                        if (index !== -1) {
                            recentChatMessages[index] = messageData;
                        }
                    } else if (change.type === "removed") {
                        // Remove message element from UI
                        const messageElementToRemove = chatMessages.querySelector(`[data-message-id="${messageData.id}"]`);
                        if (messageElementToRemove) {
                            messageElementToRemove.remove();
                        }
                        // Remove from recentChatMessages array
                        recentChatMessages = recentChatMessages.filter(msg => msg.id !== messageData.id);
                    }
                });
                console.log(`Messages updated. Total recent messages: ${recentChatMessages.length}`);
            }, (error) => {
                console.error("Error listening to messages:", error);
                showTempNotification("Error fetching messages. Please check console for details and Firebase Security Rules.", true);
            });
        }

        function setupUserListListener(dynamicAppId) {
            console.log("Setting up user list listener...");
            if (unsubscribeUsers) {
                unsubscribeUsers();
                console.log("Unsubscribed from previous user listener.");
            }

            const usersCollectionRef = collection(db, `artifacts/${dynamicAppId}/public/data/users`);
            userList.innerHTML = '<p class="text-gray-500 text-sm text-center mt-4">No other users online yet.</p>';

            unsubscribeUsers = onSnapshot(usersCollectionRef, (snapshot) => {
                adminUserList.innerHTML = ''; // Clear admin user list too
                userList.innerHTML = ''; // Clear current sidebar user list
                let usersFound = false;
                snapshot.forEach((doc) => {
                    const userData = { id: doc.id, ...doc.data() }; // Capture user document ID
                    if (userData.uid && userId && userData.uid !== userId) {
                        usersFound = true;
                        const userDiv = document.createElement('div');
                        userDiv.classList.add('flex', 'items-center', 'p-2', 'rounded-lg', 'hover:bg-gray-200', 'cursor-pointer', 'transition', 'duration-150');
                        userDiv.innerHTML = `
                            <div class="w-8 h-8 bg-blue-400 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                ${userData.name ? userData.name[0].toUpperCase() : (userData.email ? userData.email[0].toUpperCase() : 'U')}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${userData.name || (userData.email ? userData.email.split('@')[0] : 'Anonymous User')}</p>
                                <p class="text-xs text-gray-500">Role: ${userData.role ? userData.role.toUpperCase() : 'USER'}</p>
                            </div>
                        `;
                        userList.appendChild(userDiv);
                    }

                    // Populate Admin User List
                    if (currentUserRole === 'admin') {
                        const adminUserItem = document.createElement('div');
                        adminUserItem.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'border-b', 'border-gray-100', 'last:border-b-0');
                        adminUserItem.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${userData.name || userData.email} <span class="text-xs text-gray-500">(UID: ${userData.uid.substring(0, 8)}...)</span></p>
                                <p class="text-sm text-gray-600">Email: ${userData.email}</p>
                                <p class="text-sm text-gray-600">Role: <span id="admin-user-role-${userData.id}">${(userData.role || 'user').toUpperCase()}</span></p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-user-id="${userData.id}" data-current-role="${userData.role || 'user'}" class="toggle-role-button bg-yellow-500 hover:bg-yellow-600 text-white text-xs py-1 px-2 rounded-lg">
                                    ${(userData.role === 'admin' ? 'Demote' : 'Promote')}
                                </button>
                                <button data-user-id="${userData.id}" class="delete-user-button bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-lg">
                                    Delete
                                </button>
                            </div>
                        `;
                        adminUserList.appendChild(adminUserItem);
                    }
                });

                if (!usersFound) {
                    userList.innerHTML = '<p class="text-gray-500 text-sm text-center mt-4">No other users online yet.</p>';
                }

                console.log(`User list updated. Total users found (excluding self): ${snapshot.docs.length - (userId ? 1 : 0)}`);

                // Attach event listeners for admin buttons after they are rendered
                if (currentUserRole === 'admin') {
                    document.querySelectorAll('.toggle-role-button').forEach(button => {
                        button.onclick = () => {
                            const targetUserId = button.dataset.userId;
                            const currentRole = button.dataset.currentRole;
                            const newRole = (currentRole === 'admin' ? 'user' : 'admin');
                            confirmAction(`Are you sure you want to ${newRole === 'admin' ? 'promote' : 'demote'} this user?`, () => toggleUserRole(targetUserId, newRole));
                        };
                    });
                    document.querySelectorAll('.delete-user-button').forEach(button => {
                        button.onclick = () => {
                            const targetUserId = button.dataset.userId;
                            confirmAction('Are you sure you want to delete this user profile? (This does NOT delete their Firebase Auth account)', () => deleteUserFromFirestore(targetUserId));
                        };
                    });
                }

            }, (error) => {
                console.error("Error listening to users:", error);
                showTempNotification("Error fetching user list. Please check console for details and Firebase Security Rules.", true);
            });
        }

        // --- Admin Panel Functions ---
        adminPanelButton.addEventListener('click', () => {
            if (currentUserRole === 'admin') {
                adminPanelModal.classList.remove('hidden');
                // The setupUserListListener already populates adminUserList
                adminAddNameInput.value = ''; // Clear new name field
                adminAddEmailInput.value = '';
                adminAddPasswordInput.value = '';
                adminAddErrorMessage.classList.add('hidden');
            } else {
                showTempNotification("You do not have administrative privileges.", true);
            }
        });

        closeAdminModalButton.addEventListener('click', () => {
            adminPanelModal.classList.add('hidden');
        });

        adminAddUserButton.addEventListener('click', async () => {
            const name = adminAddNameInput.value.trim(); // Get name from input
            const email = adminAddEmailInput.value.trim();
            const password = adminAddPasswordInput.value.trim();
            adminAddErrorMessage.classList.add('hidden');

            if (!email || !password) {
                adminAddErrorMessage.textContent = "Email and password are required.";
                adminAddErrorMessage.classList.remove('hidden');
                return;
            }

            adminAddUserButton.disabled = true;
            const originalButtonText = adminAddUserButton.textContent;
            adminAddUserButton.textContent = 'Adding User...';

            try {
                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUserId = userCredential.user.uid;

                // Determine display name for the new user
                const displayName = name || email.split('@')[0];

                // Create user profile in Firestore with default 'user' role and name
                const dynamicAppId = firebaseConfig.projectId;
                const userRef = doc(db, `artifacts/${dynamicAppId}/public/data/users`, newUserId);
                await setDoc(userRef, {
                    email: email,
                    uid: newUserId,
                    role: 'user', // New users created by admin get 'user' role by default
                    name: displayName, // Set the provided name or derived name
                    createdAt: serverTimestamp()
                });

                showTempNotification(`User ${displayName} (${email}) added successfully!`, false);
                adminAddNameInput.value = ''; // Clear fields
                adminAddEmailInput.value = '';
                adminAddPasswordInput.value = '';
                // The user list listener will automatically update the admin panel
            } catch (error) {
                console.error("Error adding user:", error);
                let errorMessage = "Failed to add user.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak (min 6 characters).";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'permission-denied') {
                    errorMessage = "Permission denied to add user. Check Firebase Security Rules for creating users.";
                }
                adminAddErrorMessage.textContent = errorMessage;
                adminAddErrorMessage.classList.remove('hidden');
            } finally {
                adminAddUserButton.disabled = false;
                adminAddUserButton.textContent = originalButtonText;
            }
        });

        async function toggleUserRole(targetFirestoreUserId, newRole) {
            const dynamicAppId = firebaseConfig.projectId;
            const userRef = doc(db, `artifacts/${dynamicAppId}/public/data/users`, targetFirestoreUserId);
            try {
                await updateDoc(userRef, { role: newRole });
                console.log(`User ${targetFirestoreUserId} role updated to ${newRole}.`);
                showTempNotification(`User role updated to ${newRole.toUpperCase()}!`, false);
                // UI will update automatically via onSnapshot listener
            } catch (error) {
                console.error("Error toggling user role:", error);
                showTempNotification(`Failed to change user role: ${error.message}. Check admin security rules.`, true);
            }
        }

        async function deleteUserFromFirestore(targetFirestoreUserId) {
             const dynamicAppId = firebaseConfig.projectId;
             const userRef = doc(db, `artifacts/${dynamicAppId}/public/data/users`, targetFirestoreUserId);
             try {
                // Delete user's profile from Firestore
                await deleteDoc(userRef);
                console.log(`User profile ${targetFirestoreUserId} deleted from Firestore.`);
                showTempNotification("User profile deleted from Firestore.", false);
                // IMPORTANT: This does NOT delete the user's authentication record in Firebase Auth.
                // To do that, you'd need a Firebase Cloud Function or manual deletion in the console.
                showTempNotification("User's Firebase Auth account must be deleted manually from Firebase Console Authentication tab for full removal.", true);

             } catch (error) {
                 console.error("Error deleting user profile from Firestore:", error);
                 showTempNotification(`Failed to delete user profile: ${error.message}. Check admin security rules.`, true);
             }
        }


        // --- Gemini API Integrations ---
        async function callGeminiAPI(promptText) {
            console.log("Calling Gemini API with prompt:", promptText);
            try {
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: promptText }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API error response:", errorBody);
                    throw new Error(`Gemini API request failed: ${response.status} ${response.statusText} - ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();
                console.log("Gemini API raw response:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Gemini API response structure unexpected, no candidates found:", result);
                    return null;
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showTempNotification("Failed to connect to AI service or retrieve response. Check console for details.", true);
                return null;
            }
        }

        summarizeChatButton.addEventListener('click', async () => {
            console.log("Summarize chat button clicked.");
            if (!recentChatMessages.length) {
                showTempNotification("No messages to summarize yet!", false);
                return;
            }
            if (!userId) {
                showTempNotification("Please log in to summarize chat.", true);
                return;
            }

            let chatTranscript = recentChatMessages.map(msg => {
                const sender = msg.senderName || (msg.senderEmail ? msg.senderEmail.split('@')[0] : 'Unknown'); // Use senderName for summary context
                const time = msg.timestamp && msg.timestamp.toDate ? msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'unknown time';
                return `${sender} (${time}): ${msg.text}`;
            }).join('\n');

            const prompt = `Summarize the following chat transcript concisely, highlighting main topics and key points. If there are no substantial conversations, state that.
            \n--- Transcript ---\n${chatTranscript}`;

            summarizeChatButton.disabled = true;
            const originalButtonText = summarizeChatButton.textContent;
            summarizeChatButton.textContent = 'Summarizing...';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const summary = await callGeminiAPI(prompt);
                if (summary) {
                    const dynamicAppId = firebaseConfig.projectId;
                    console.log("Summary generated, adding to chat:", summary);
                    await addDoc(collection(db, `artifacts/${dynamicAppId}/public/data/messages`), {
                        senderId: 'gemini-summary',
                        senderEmail: 'Gemini AI',
                        senderName: 'Gemini AI', // Set name for AI messages
                        text: `✨ Chat Summary: ${summary}`,
                        timestamp: serverTimestamp()
                    });
                    showTempNotification("Chat summarized successfully!", false);
                } else {
                    showTempNotification("Could not generate summary. AI returned no text.", true);
                }
            } catch (error) {
                console.error("Error during chat summarization:", error);
                showTempNotification("An error occurred while summarizing the chat. Check console.", true);
            } finally {
                summarizeChatButton.disabled = false;
                summarizeChatButton.textContent = originalButtonText;
            }
        });

        draftMessageButton.addEventListener('click', () => {
            console.log("Draft message button clicked.");
            if (!userId || !currentUserEmail) {
                showTempNotification("Please log in to draft messages.", true);
                return;
            }
            draftMessageModal.classList.remove('hidden');
            draftPromptInput.value = '';
            generatedDraftOutput.textContent = '';
            generatedDraftOutput.classList.add('hidden');
            draftErrorMessage.classList.add('hidden');
            sendGeneratedDraftButton.classList.add('hidden');
        });

        closeDraftModalButton.addEventListener('click', () => {
            console.log("Close draft modal button clicked.");
            draftMessageModal.classList.add('hidden');
        });

        generateDraftButton.addEventListener('click', async () => {
            const topic = draftPromptInput.value.trim();
            console.log("Generate draft button clicked. Topic:", topic);
            if (!topic) {
                draftErrorMessage.textContent = "Please enter a topic for your message.";
                draftErrorMessage.classList.remove('hidden');
                return;
            }

            draftLoadingSpinner.classList.remove('hidden');
            generateDraftButton.disabled = true;
            const originalGenerateText = generateDraftButton.textContent;
            generateDraftButton.textContent = 'Generating...';
            generatedDraftOutput.classList.add('hidden');
            draftErrorMessage.classList.add('hidden');
            sendGeneratedDraftButton.classList.add('hidden');


            const prompt = `Draft a concise chat message about "${topic}" suitable for a public chat. Keep it under 100 words.`;

            try {
                const draft = await callGeminiAPI(prompt);
                if (draft) {
                    generatedDraftOutput.textContent = draft;
                    generatedDraftOutput.classList.remove('hidden');
                    sendGeneratedDraftButton.classList.remove('hidden');
                    console.log("Message draft generated:", draft);
                } else {
                    draftErrorMessage.textContent = "Could not generate draft. Gemini API returned no text.";
                    draftErrorMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error generating message draft:", error);
                draftErrorMessage.textContent = "An error occurred while generating the draft. Check console.";
                draftErrorMessage.classList.remove('hidden');
            } finally {
                draftLoadingSpinner.classList.add('hidden');
                generateDraftButton.disabled = false;
                generateDraftButton.textContent = originalGenerateText;
            }
        });

        sendGeneratedDraftButton.addEventListener('click', async () => {
            const draftText = generatedDraftOutput.textContent.trim();
            console.log("Send generated draft button clicked. Draft text:", draftText);
            if (draftText && userId && currentUserEmail) {
                const dynamicAppId = firebaseConfig.projectId;
                try {
                    console.log("Attempting to send drafted message to Firestore...");
                    await addDoc(collection(db, `artifacts/${dynamicAppId}/public/data/messages`), {
                        senderId: userId,
                        senderEmail: currentUserEmail,
                        senderName: currentUserName, // New: Include sender's name
                        text: draftText,
                        timestamp: serverTimestamp()
                    });
                    draftMessageModal.classList.add('hidden');
                    messageInput.value = '';
                    showTempNotification("Drafted message sent!", false);
                    console.log("Drafted message sent successfully!");
                } catch (error) {
                    console.error("Error sending drafted message to Firestore:", error);
                    let displayError = "Failed to send drafted message. Please check internet connection/permissions.";
                    if (error.code === 'permission-denied') {
                        displayError = "Failed to send drafted message: Permission denied. Check Firebase Security Rules for 'messages' collection.";
                    } else if (error.code === 'unavailable' || error.code === 'internal') {
                        displayError = "Network issue or Firestore service unavailable. Please check your internet connection.";
                    }
                    showTempNotification(displayError, true);
                }
            } else {
                console.warn("Cannot send drafted message: Draft text empty, or user not logged in.");
                showTempNotification("Draft message is empty or you are not logged in.", true);
            }
        });

        // --- Profile Modal Functions ---
        profileButton.addEventListener('click', () => {
            if (userId && currentUserEmail) {
                // Pre-populate fields with current user info
                profileEmail.textContent = currentUserEmail;
                profileUid.textContent = userId;
                profileRole.textContent = currentUserRole.toUpperCase();
                profileNameInput.value = currentUserName; // Populate name input field
                // Clear password fields and messages
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                passwordChangeErrorMessage.classList.add('hidden');
                passwordChangeSuccessMessage.classList.add('hidden');
                profileNameMessage.classList.add('hidden'); // Hide name message
                profileModal.classList.remove('hidden');
            } else {
                showTempNotification("Please log in to view your profile.", true);
            }
        });

        closeProfileModalButton.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        // Save Name Button Listener
        saveProfileNameButton.addEventListener('click', async () => {
            const newName = profileNameInput.value.trim();
            profileNameMessage.classList.add('hidden'); // Hide previous messages

            if (!newName) {
                profileNameMessage.textContent = "Name cannot be empty.";
                profileNameMessage.classList.remove('hidden');
                profileNameMessage.classList.remove('text-green-600');
                profileNameMessage.classList.add('text-red-600');
                return;
            }

            if (newName === currentUserName) {
                profileNameMessage.textContent = "Name is already the same.";
                profileNameMessage.classList.remove('hidden');
                profileNameMessage.classList.remove('text-red-600');
                profileNameMessage.classList.add('text-green-600');
                return;
            }

            saveProfileNameButton.disabled = true;
            const originalButtonText = saveProfileNameButton.textContent;
            saveProfileNameButton.textContent = 'Saving Name...';

            const dynamicAppId = firebaseConfig.projectId;
            const userRef = doc(db, `artifacts/${dynamicAppId}/public/data/users`, userId);

            try {
                await updateDoc(userRef, { name: newName });
                currentUserName = newName; // Update global variable
                profileNameInput.value = newName; // Ensure input reflects latest
                console.log(`User name updated to: ${newName}`);
                profileNameMessage.textContent = "Name updated successfully!";
                profileNameMessage.classList.remove('hidden');
                profileNameMessage.classList.remove('text-red-600');
                profileNameMessage.classList.add('text-green-600');
                showTempNotification("Your name has been updated!", false);

            } catch (error) {
                console.error("Error updating user name:", error);
                let errorMessage = `Failed to update name: ${error.message}`;
                if (error.code === 'permission-denied') {
                    errorMessage = "Failed to update name: Permission denied. Check Firebase Security Rules for user profiles.";
                }
                profileNameMessage.textContent = errorMessage;
                profileNameMessage.classList.remove('hidden');
                profileNameMessage.classList.remove('text-green-600');
                profileNameMessage.classList.add('text-red-600');
                showTempNotification(`Name update failed: ${errorMessage}`, true);
            } finally {
                saveProfileNameButton.disabled = false;
                saveProfileNameButton.textContent = originalButtonText;
            }
        });


        changePasswordButton.addEventListener('click', async () => {
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;

            passwordChangeErrorMessage.classList.add('hidden');
            passwordChangeSuccessMessage.classList.add('hidden');

            if (!currentPassword || !newPassword) {
                passwordChangeErrorMessage.textContent = "Both current and new passwords are required.";
                passwordChangeErrorMessage.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                passwordChangeErrorMessage.textContent = "New password must be at least 6 characters long.";
                passwordChangeErrorMessage.classList.remove('hidden');
                return;
            }

            if (currentPassword === newPassword) {
                passwordChangeErrorMessage.textContent = "New password cannot be the same as the current password.";
                passwordChangeErrorMessage.classList.remove('hidden');
                return;
            }

            changePasswordButton.disabled = true;
            const originalButtonText = changePasswordButton.textContent;
            changePasswordButton.textContent = 'Changing...';

            const user = auth.currentUser;
            if (user) {
                try {
                    // Re-authenticate user with their current credentials
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);
                    console.log("User re-authenticated successfully.");

                    // Update password
                    await updatePassword(user, newPassword);
                    console.log("Password updated successfully!");
                    passwordChangeSuccessMessage.textContent = "Password changed successfully!";
                    passwordChangeSuccessMessage.classList.remove('hidden');
                    currentPasswordInput.value = ''; // Clear fields
                    newPasswordInput.value = '';
                    showTempNotification("Password changed successfully!", false);

                    // Optionally, close modal after a short delay
                    setTimeout(() => profileModal.classList.add('hidden'), 2000);

                } catch (error) {
                    console.error("Error changing password:", error);
                    let errorMessage = "Failed to change password. Please try again.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect current password.";
                    } else if (error.code === 'auth/requires-recent-login') {
                        errorMessage = "Please log out and log back in to change your password.";
                    } else if (error.code === 'auth/weak-password') {
                         errorMessage = "New password is too weak (min 6 characters).";
                    }
                    passwordChangeErrorMessage.textContent = errorMessage;
                    passwordChangeErrorMessage.classList.remove('hidden');
                    showTempNotification(`Password change failed: ${errorMessage}`, true);
                } finally {
                    changePasswordButton.disabled = false;
                    changePasswordButton.textContent = originalButtonText;
                }
            } else {
                passwordChangeErrorMessage.textContent = "No user logged in.";
                passwordChangeErrorMessage.classList.remove('hidden');
            }
        });


        // Initialize on window load
        window.onload = function() {
            showLoadingSpinner();
            initializeFirebase();
        };

    </script>
</body>
</html>
